(function(r,t){typeof exports=="object"&&typeof module!="undefined"?t(exports,require("react/jsx-runtime"),require("@nocobase/client"),require("antd"),require("lodash"),require("react"),require("@formily/shared"),require("@formily/react")):typeof define=="function"&&define.amd?define(["exports","react/jsx-runtime","@nocobase/client","antd","lodash","react","@formily/shared","@formily/react"],t):(r=typeof globalThis!="undefined"?globalThis:r||self,t(r["@nocobase/plugin-dumu-saas-store"]={},r.jsxRuntime,r["@nocobase/client"],r.antd,r.lodash,r.react,r["@formily/shared"],r["@formily/react"]))})(this,function(r,t,e,y,S,d,A,f){"use strict";var W=Object.defineProperty,Z=Object.defineProperties;var R=Object.getOwnPropertyDescriptors;var M=Object.getOwnPropertySymbols;var ee=Object.prototype.hasOwnProperty,te=Object.prototype.propertyIsEnumerable;var N=(r,t,e)=>t in r?W(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e,h=(r,t)=>{for(var e in t||(t={}))ee.call(t,e)&&N(r,e,t[e]);if(M)for(var e of M(t))te.call(t,e)&&N(r,e,t[e]);return r},T=(r,t)=>Z(r,R(t));var _=(r,t,e)=>new Promise((y,S)=>{var d=i=>{try{f(e.next(i))}catch(C){S(C)}},A=i=>{try{f(e.throw(i))}catch(C){S(C)}},f=i=>i.done?y(i.value):Promise.resolve(i.value).then(d,A);f((e=e.apply(r,t)).next())});const i="dumuSaasStore",C={tenant:"tenant",store:"store",employee:"employee",storeDepartment:"storeDepartment",storeDepartmentUsers:"storeDepartmentUsers"},$={store:"duMuSaasStoreId",tenant:"duMuSaasTenantId",departmentId:"orgId"},x={store:"duMuSaasStore",tenant:"duMuSaasTenant",department:"departments",employee:"employees"},O="X-Store",D="DUMU_SAAS_STORE_ID_CACHE_KEY",q="name",B=["roles",C.tenant,C.store,C.storeDepartment,C.storeDepartmentUsers],K=f.observer(n=>{const{value:c}=n,a=e.useCompile();return t.jsx(t.Fragment,{children:c.map(s=>t.jsx(y.Tag,{color:s.color,children:a(s.name)},s.name))})},{displayName:"CollectionCategory"}),j=f.observer(n=>{const{value:c}=n,{getTemplate:a}=e.useCollectionManager(),s=e.useCompile(),l=a(c);return t.jsx(y.Tag,{children:s((l==null?void 0:l.title)||'{{t("General collection")}}')})},{displayName:"CollectionTemplate"}),w={type:"object",properties:{block1:{type:"void","x-collection":"collections","x-decorator":"ResourceActionProvider","x-decorator-props":{collection:e.collection,dragSort:!0,request:{resource:"collections",action:"list",params:{pageSize:50,sort:"sort",filter:{"hidden.$isFalsy":!0},appends:["category"]}}},properties:{tabs:{type:"void","x-component":"ConfigurationTabs"}}}}},P={type:"object",properties:{[A.uid()]:{type:"void","x-component":"ActionBar","x-component-props":{style:{marginBottom:10}},properties:{filter:{type:"void",title:'{{ t("Filter") }}',default:{$and:[{title:{$includes:""}},{name:{$includes:""}}]},"x-action":"filter","x-component":"Filter.Action","x-component-props":{icon:"FilterOutlined",useProps:"{{ cm.useFilterActionProps }}"},"x-align":"left"}}},tip:{type:"void","x-component":"div","x-content":"开启后将为此数据表创建dumuSaasStoreId字段（开启实际是给数据表增加了一个dumuSaasStoreId字段，您也可以手动添加），开启后不能手动关闭，如需关闭，请手动删除数据库dumuSaasStoreId字段；users和roles不能增加该字段。","x-component-props":{style:{marginBottom:10}}},[A.uid()]:{type:"void","x-uid":"input","x-component":"Table.Void","x-component-props":{rowKey:"name",rowSelection:{type:"checkbox"},useDataSource:"{{ cm.useDataSourceFromRAC }}",sortDirections:[]},properties:{column1:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",properties:{title:{"x-component":"CollectionField","x-read-pretty":!0}}},column2:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",properties:{name:{type:"string","x-component":"CollectionField","x-read-pretty":!0}}},column3:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column",title:'{{t("Collection template")}}',properties:{template:{"x-component":j,"x-read-pretty":!0}}},column4:{type:"void","x-decorator":"Table.Column.Decorator","x-component":"Table.Column","x-visible":"categoryVisible",title:'{{t("Collection category")}}',properties:{category:{"x-component":K,"x-read-pretty":!0}}},column5:{type:"void",title:'{{ t("Actions") }}',"x-component":"Table.Column",properties:{drawer:{type:"void","x-component":"Action.Link",title:"开启","x-component-props":{confirm:{title:"提示",content:"开启后将为此数据表创建dumuSaasStoreId字段，开启后不能手动关闭，如需关闭，请手动删除数据库改字段列"},useAction:"{{ useSaasAction }}"},"x-reactions":n=>{const c=n.path.segments[1],a=n.path.segments[0],s=n.form.getValuesIn(`${a}.${c}`);if(s){n.title="开启",B.includes(s.name)&&(n.disabled=!0);const{getCollectionFields:l}=e.useCollectionManager();S.find(l(s.name),{name:x.store})&&(n.disabled=!0,n.setTitle("已开启"))}}}}}}}}},L=()=>{const{name:n}=e.useRecord(),c=e.useActionContext(),a=e.useAPIClient(),{refreshCM:s}=e.useCollectionManager();return{run(){return _(this,null,function*(){c.setVisible(!1),yield a.request({url:"saasStore:use",params:{tableName:n}}),yield s()})}}},E=d.createContext({}),U=()=>{const{collections:n=[],interfaces:c}=e.useCollectionManager(),{data:{database:a}}=e.useCurrentAppInfo(),l=e.useAPIClient().resource("dbViews"),g=d.useRef();g.current=n;const I=e.useCompile(),b=()=>_(this,null,function*(){return l.list().then(({data:p})=>{var v;return(v=p==null?void 0:p.data)==null?void 0:v.map(o=>{const u=o.schema;return{label:u?`${u}.${I(o.name)}`:o.name,value:u?`${u}_${o.name}`:o.name}})})}),m=d.useContext(E);return t.jsx(E.Provider,{value:T(h({},m),{designable:!1}),children:t.jsx(e.SchemaComponent,{schema:w,components:{CollectionFieldsTable:e.CollectionFieldsTable},scope:{loadDBViews:b,useSaasAction:L,interfaces:c,enableInherits:(a==null?void 0:a.dialect)==="postgres",isPG:(a==null?void 0:a.dialect)==="postgres"}})})},V=()=>{const{data:n}=d.useContext(e.CollectionCategroriesContext),{run:c,defaultRequest:a,setState:s}=e.useResourceActionContext(),[l,g]=d.useState("all"),[I,b]=d.useState("all"),m=e.useCompile();if(!n)return null;const p=n.sort((o,u)=>u.sort-o.sort).concat().map(o=>T(h({},o),{schema:P}));!p.find(o=>o.id==="all")&&p.unshift({name:'{{t("All collections")}}',id:"all",sort:0,closable:!1,schema:P});const v=o=>{var u;if(b(o),g(A.uid()),o!=="all"){const F={$and:[(u=a==null?void 0:a.params)==null?void 0:u.filter,{"category.id":o}]};c({filter:F}),s==null||s({category:[+o],params:[{filter:F}]})}else c(),s==null||s({category:[],params:[]})};return t.jsx(y.Tabs,{onChange:v,hideAdd:!0,defaultActiveKey:"all",type:"editable-card",destroyInactiveTabPane:!0,tabBarStyle:{marginBottom:"0px"},items:p.map(o=>({label:m(o.name),key:o.id,closable:!1,children:t.jsx(y.Card,{bordered:!1,children:t.jsx(f.RecursionField,{name:l,schema:o.schema,onlyRenderProperties:!0})})}))})},Y={type:"object",properties:{[A.uid()]:{"x-component":"ConfigurationTable"}}},H=()=>t.jsx(e.SchemaComponent,{schema:Y,components:{ConfigurationTable:U,ConfigurationTabs:V}}),{defaultProps:k,operators:G}=e.interfacesProperties,z={name:i,type:"object",group:"systemInfo",order:9,title:"saas多门店字段",description:"saas多门店字段",sortable:!0,default:{name:x.store,type:"belongsTo",interface:"m2o",collectionName:x.store,foreignKey:$.store,onDelete:"NO ACTION",target:C.store,targetKey:"id",uiSchema:{"x-component":"AssociationField","x-component-props":{multiple:!1,fieldNames:{label:q,value:"id"}},title:"门店"}},properties:T(h({},k),{"uiSchema.title":{type:"string",title:'{{t("Field display name")}}',required:!0,default:"ID","x-decorator":"FormItem","x-component":"Input"},name:{type:"string",title:'{{t("Field name")}}',required:!0,"x-disabled":!0,"x-decorator":"FormItem","x-component":"Input",description:"saas多门店字段"}}),filterable:{operators:G.number}},X=()=>{const n=e.useAPIClient(),c=+n.storage.getItem(D);n.axios.interceptors.request.use(o=>(o.headers[O]=c,o));const a=e.useCurrentUserContext().data.data,s=a[x.store],l=a[x.tenant];let g=[];const I={padding:"10px"};if(s.length===1)return t.jsx("a",{href:"#",style:I,children:s[0].name});let b;const m=S.find(s,o=>o.id===c)||s[0];if(!m)return;let p=m.name;l.length===1?(g=S.map(s,o=>T(h({},o),{[x.store]:[]})),b=m.id):(g=l,p=`${m[x.tenant].name} / ${p}`,b=[m[x.tenant].id,m.id]);const v=o=>{const u=S.last(o);n.storage.setItem(D,u),window.location.reload()};return t.jsx(y.Cascader,{options:g,fieldNames:{label:"name",value:"id",children:x.store},onChange:v,defaultValue:b,placeholder:"选择门店",children:t.jsx("a",{href:"#",style:I,children:p})})},J=d.memo(n=>{const c=d.useContext(e.CollectionManagerContext);return t.jsx(e.PinnedPluginListProvider,{items:{[i]:{order:1,component:"SaasStoreManager",snippet:"pm.*"}},children:t.jsx(e.SettingsCenterProvider,{settings:{[i]:{title:"saas多门店",icon:"appstoreoutlined",tabs:{tab2:{title:"saas多门店字段配置",component:()=>t.jsx(H,{})}}}},children:t.jsx(e.SchemaComponentOptions,{components:{SaasStoreManager:X},children:t.jsx(e.CollectionManagerContext.Provider,{value:T(h({},c),{interfaces:T(h({},c.interfaces),{[i]:z})}),children:n.children})})})})});class Q extends e.Plugin{load(){return _(this,null,function*(){this.app.addProvider(J)})}}r.default=Q,Object.defineProperties(r,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
